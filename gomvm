#!/bin/bash

# gomvm - Go Multi Version Manager
# A wrapper script for managing multiple Go versions

# è‰²ã®å®šç¾©
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# å®‰å…¨ãªçµ‚äº†å‡¦ç†ã®ãŸã‚ã®é–¢æ•°
safe_exit() {
  # ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒ source ã§å®Ÿè¡Œã•ã‚ŒãŸå ´åˆã¯ return ã‚’ä½¿ç”¨
  # ãã†ã§ãªã„å ´åˆã¯ exit ã‚’ä½¿ç”¨
  if [[ "${BASH_SOURCE[0]}" != "${0}" ]]; then
    return "$1"
  else
    exit "$1"
  fi
}

# ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
print_info() {
  echo -e "${BLUE}â„¹ï¸ $1${NC}"
}

print_success() {
  echo -e "${GREEN}âœ… $1${NC}"
}

print_warning() {
  echo -e "${YELLOW}âš ï¸ $1${NC}"
}

print_error() {
  echo -e "${RED}âŒ $1${NC}"
}

# Help function
show_help() {
  echo -e "${PURPLE}ğŸ”§ Go Multi Version Manager (gomvm)${NC}"
  echo ""
  echo -e "${PURPLE}ä½¿ç”¨æ–¹æ³•:${NC}"
  echo -e "  ${GREEN}gomvm install <version>${NC}    - Go ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"
  echo -e "  ${GREEN}gomvm switch <version>${NC}     - Go ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’åˆ‡ã‚Šæ›¿ãˆ (source ã‚³ãƒãƒ³ãƒ‰ã¨å…±ã«ä½¿ç”¨)"
  echo -e "  ${GREEN}gomvm list${NC}                 - åˆ©ç”¨å¯èƒ½ãª Go ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä¸€è¦§è¡¨ç¤º"
  echo -e "  ${GREEN}gomvm installed${NC}            - ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ã® Go ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä¸€è¦§è¡¨ç¤º"
  echo -e "  ${GREEN}gomvm uninstall <version>${NC}  - Go ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"
  echo -e "  ${GREEN}gomvm setup${NC}                - ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”¨ã« gomvm ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—"
  echo -e "  ${GREEN}gomvm uninstall-self${NC}       - gomvm è‡ªä½“ã‚’ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"
  echo -e "  ${GREEN}gomvm help${NC}                 - ã“ã®ãƒ˜ãƒ«ãƒ—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º"
  echo ""
  echo -e "${PURPLE}ä¾‹:${NC}"
  echo -e "  ${GREEN}gomvm install 1.24.1${NC}       - Go 1.24.1 ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"
  echo -e "  ${GREEN}source gomvm switch 1.24.1${NC} - Go 1.24.1 ã«åˆ‡ã‚Šæ›¿ãˆ"
}

# Dynamic configuration - automatically find the script directory
# Try to load the configuration file if it exists
GOMVM_CONFIG_DIR="$HOME/.config/gomvm"
GOMVM_CONFIG_FILE="$GOMVM_CONFIG_DIR/config"

if [ -f "$GOMVM_CONFIG_FILE" ]; then
  # shellcheck source=/dev/null
  source "$GOMVM_CONFIG_FILE" || print_warning "è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ"
fi

# ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æœ€å„ªå…ˆ
REAL_PATH="$(readlink -f "$0")"
CURRENT_DIR_SCRIPTS="$(dirname "$REAL_PATH")/scripts/ubuntu"

# Try various possible locations for the scripts, prioritizing current directory
for dir in \
  "$CURRENT_DIR_SCRIPTS" \
  "$(dirname "$(dirname "$REAL_PATH")")/scripts/ubuntu" \
  "$GOMVM_SCRIPTS_DIR" \
  "$HOME/go-multi-version-manager/scripts/ubuntu" \
  "$HOME/golang/go-multi-version-manager/scripts/ubuntu"; do
  if [ -d "$dir" ]; then
    SCRIPT_DIR="$dir"
    break
  fi
done

# Verify the SCRIPT_DIR exists and contains required scripts
if [ -z "$SCRIPT_DIR" ] || [ ! -d "$SCRIPT_DIR" ] || [ ! -f "$SCRIPT_DIR/switch_go_version.sh" ]; then
  print_error "ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚‰ãªã„ã‹ã€å¿…è¦ãªã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚"
  print_info "GOMVM_SCRIPTS_DIR ç’°å¢ƒå¤‰æ•°ã‚’ubuntuã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ãƒ‘ã‚¹ã«è¨­å®šã—ã¦ãã ã•ã„ã€‚"
  echo -e "${CYAN}ä¾‹: export GOMVM_SCRIPTS_DIR=/path/to/go-multi-version-manager/scripts/ubuntu${NC}"
  safe_exit 1
fi

# Function to execute a script with arguments
run_script() {
  local script="$1"
  shift
  
  # Check if the script exists
  if [ ! -f "${SCRIPT_DIR}/${script}" ]; then
    print_error "ã‚¹ã‚¯ãƒªãƒ—ãƒˆ ${script} ãŒ ${SCRIPT_DIR} ã«è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
    safe_exit 1
  fi
  
  if [[ "$script" == "switch_go_version.sh" ]]; then
    # å®‰å…¨ã«å®Ÿè¡Œã™ã‚‹ãŸã‚ã®å‡¦ç†
    # å…ƒã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ä»£ã‚ã‚Šã«ç›´æ¥å‡¦ç†ã‚’è¡Œã†
    switch_go_directly "$@"
  else
    # For other scripts, we can execute them directly
    "${SCRIPT_DIR}/${script}" "$@" || {
      print_error "ã‚¹ã‚¯ãƒªãƒ—ãƒˆ ${script} ã¯çµ‚äº†ã‚³ãƒ¼ãƒ‰ $? ã§å¤±æ•—ã—ã¾ã—ãŸ"
      safe_exit 1
    }
  fi
}

# Safer alternative to switch_go_version.sh
switch_go_directly() {
  local GO_VERSION=$1
  
  if [ -z "$GO_VERSION" ]; then
    print_error "Go ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®å¼•æ•°ãŒã‚ã‚Šã¾ã›ã‚“ã€‚"
    print_info "ä½¿ç”¨æ³•: source gomvm switch <go_version>"
    safe_exit 1
  fi
  
  # Temporarily add $HOME/go/bin to PATH
  if ! echo "$PATH" | grep -q "$HOME/go/bin"; then
    export PATH="$HOME/go/bin:$PATH"
  fi
  
  # Check if goX.X.X command exists
  if ! command -v "go${GO_VERSION}" &> /dev/null; then
    print_info "Go ãƒãƒ¼ã‚¸ãƒ§ãƒ³ $GO_VERSION ã¯ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™..."
    "${SCRIPT_DIR}/install_go_with_command.sh" "${GO_VERSION}" || {
      print_error "Go $GO_VERSION ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
      safe_exit 1
    }
    
    # Verify installation after setting PATH
    if ! command -v "go${GO_VERSION}" &> /dev/null; then
      print_error "ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ç¢ºèªã«å¤±æ•—ã—ã¾ã—ãŸã€‚PATHè¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
      safe_exit 1
    fi
  fi
  
  # Get the correct GOROOT for the specified version
  # First, find the binary location
  local GO_BINARY_PATH
  GO_BINARY_PATH=$(command -v "go${GO_VERSION}")
  
  if [ -z "$GO_BINARY_PATH" ]; then
    print_error "go${GO_VERSION} ãƒã‚¤ãƒŠãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚"
    safe_exit 1
  fi
  
  # Get GOROOT from the specific version binary
  local NEW_GOROOT
  NEW_GOROOT=$("go${GO_VERSION}" env GOROOT)
  
  if [ -z "$NEW_GOROOT" ] || [ ! -d "$NEW_GOROOT" ]; then
    print_error "Go ${GO_VERSION} ã® GOROOT ãŒå–å¾—ã§ãã¾ã›ã‚“ã€‚"
    safe_exit 1
  fi
  
  # Update environment variables in the correct order
  export GOROOT="$NEW_GOROOT"
  export PATH="$NEW_GOROOT/bin:$HOME/go/bin:$PATH"
  
  # Remove duplicate entries from PATH
  PATH_TEMP=$(echo "$PATH" | awk -v RS=':' '!a[$1]++' | paste -sd:)
  export PATH="$PATH_TEMP"
  
  # Set GOPATH to default if not set
  if [ -z "$GOPATH" ]; then
    export GOPATH="$HOME/go"
  fi
  
  # Save version selection for persistence
  local GO_SELECTED_VERSION_FILE="$HOME/.go_selected_version"
  echo "$GO_VERSION" > "$GO_SELECTED_VERSION_FILE"
  
  # Confirm version switch
  print_success "Go $GO_VERSION ã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸã€‚"
  print_info "ç¾åœ¨ã® Go ãƒãƒ¼ã‚¸ãƒ§ãƒ³: $(go version)"
  print_info "GOROOT: $GOROOT"
  print_info "GOPATH: $GOPATH"
  print_info "ãƒã‚¤ãƒŠãƒªã®å ´æ‰€: $(which go)"
}

# Main command handler
if [ $# -eq 0 ]; then
  # å¼•æ•°ãªã—ã§å®Ÿè¡Œã•ã‚ŒãŸå ´åˆã¯ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º
  show_help
  safe_exit 0
fi

case "$1" in
  "install")
    if [ -z "$2" ]; then
      print_error "ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ãŒå¿…è¦ã§ã™ã€‚"
      print_info "ä½¿ç”¨æ³•: gomvm install <version>"
      safe_exit 1
    fi
    run_script "install_go_with_command.sh" "$2"
    ;;
  
  "replace-default")
    if [ -z "$2" ]; then
      print_error "ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ãŒå¿…è¦ã§ã™ã€‚"
      print_info "ä½¿ç”¨æ³•: gomvm replace-default <version>"
      safe_exit 1
    fi
    run_script "install_go_replace_default.sh" "$2"
    ;;
    
  "install-specific")
    if [ -z "$2" ]; then
      print_error "ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ãŒå¿…è¦ã§ã™ã€‚"
      print_info "ä½¿ç”¨æ³•: gomvm install-specific <version>"
      safe_exit 1
    fi
    run_script "install_go_specific.sh" "$2"
    ;;
    
  "switch")
    if [ -z "$2" ]; then
      print_error "ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ãŒå¿…è¦ã§ã™ã€‚"
      print_info "ä½¿ç”¨æ³•: source gomvm switch <version>"
      safe_exit 1
    fi
    
    # ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒ source ã§å®Ÿè¡Œã•ã‚ŒãŸã‹ã‚’ç¢ºèª
    if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
      print_warning "'gomvm switch' ã¯ç¾åœ¨ã®ã‚·ã‚§ãƒ«ã«å½±éŸ¿ã™ã‚‹ãŸã‚ã€'source' ã¨å…±ã«å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚"
      print_info "ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„: source gomvm switch $2"
      safe_exit 1
    fi
    
    switch_go_directly "$2"
    ;;
    
  "list")
    run_script "list_go_versions.sh"
    ;;
    
  "installed")
    run_script "go_versions.sh"
    ;;
    
  "uninstall")
    if [ -z "$2" ]; then
      print_error "ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ãŒå¿…è¦ã§ã™ã€‚"
      print_info "ä½¿ç”¨æ³•: gomvm uninstall <version>"
      safe_exit 1
    fi
    run_script "uninstall_go_with_command.sh" "$2"
    ;;
    
  "setup")
    # Setup gomvm for current user
    print_info "ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”¨ã« gomvm ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¦ã„ã¾ã™..."
    
    # Create bin directory if it doesn't exist
    mkdir -p "$HOME/.local/bin"
    
    # Copy or create a symlink to this script
    SCRIPT_PATH="$(readlink -f "$0")"
    TARGET_PATH="$HOME/.local/bin/gomvm"
    
    if [ "$SCRIPT_PATH" != "$TARGET_PATH" ]; then
      cp "$SCRIPT_PATH" "$TARGET_PATH"
      chmod +x "$TARGET_PATH"
      print_success "gomvm ã‚’ $TARGET_PATH ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"
    else
      print_info "gomvm ã¯ã™ã§ã« $TARGET_PATH ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã™"
    fi
    
    # Check if PATH includes ~/.local/bin
    if ! echo "$PATH" | grep -q "$HOME/.local/bin"; then
      echo "export PATH=\"\$HOME/.local/bin:\$PATH\"" >> "$HOME/.bashrc"
      print_success "\$HOME/.local/bin ã‚’ ~/.bashrc ã® PATH ã«è¿½åŠ ã—ã¾ã—ãŸ"
      print_info "ç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’æ›´æ–°ã™ã‚‹ã«ã¯ 'source ~/.bashrc' ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„"
    else
      print_info "\$HOME/.local/bin ã¯ã™ã§ã« PATH ã«å«ã¾ã‚Œã¦ã„ã¾ã™"
    fi
    
    # Store the scripts directory in user config
    mkdir -p "$GOMVM_CONFIG_DIR"
    echo "GOMVM_SCRIPTS_DIR=\"$SCRIPT_DIR\"" > "$GOMVM_CONFIG_FILE"
    print_success "è¨­å®šã‚’ $GOMVM_CONFIG_FILE ã«ä¿å­˜ã—ã¾ã—ãŸ"
    
    echo ""
    print_success "gomvm ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸï¼"
    print_info "ã“ã‚Œã§ä»»æ„ã®å ´æ‰€ã‹ã‚‰ 'gomvm' ã‚’ä½¿ç”¨ã§ãã¾ã™ã€‚"
    print_info "Go ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ã«ã¯: source gomvm switch <version>"
    echo -e "${CYAN}ä¾‹: source gomvm switch 1.24.0${NC}"
    print_info "ç¾åœ¨ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: $SCRIPT_DIR"
    ;;
  
  "uninstall-self")
    # Uninstall gomvm
    print_info "gomvm ã‚’ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ã¾ã™..."
    
    # Confirm uninstallation
    read -r -p "æœ¬å½“ã« gomvm ã‚’ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã‹ï¼Ÿ (y/N): " confirm
    if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
      print_info "ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚"
      safe_exit 0
    fi
    
    # Remove gomvm binary
    if [ -f "$HOME/.local/bin/gomvm" ]; then
      rm -f "$HOME/.local/bin/gomvm"
      print_success "gomvm ãƒã‚¤ãƒŠãƒªã‚’ $HOME/.local/bin/gomvm ã‹ã‚‰å‰Šé™¤ã—ã¾ã—ãŸ"
    else
      print_info "gomvm ãƒã‚¤ãƒŠãƒªãŒ $HOME/.local/bin ã«è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
    fi
    
    # Remove configuration
    if [ -d "$GOMVM_CONFIG_DIR" ]; then
      rm -rf "$GOMVM_CONFIG_DIR"
      print_success "è¨­å®šãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª $GOMVM_CONFIG_DIR ã‚’å‰Šé™¤ã—ã¾ã—ãŸ"
    fi
    
    echo ""
    print_success "gomvm ã®ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå®Œäº†ã—ã¾ã—ãŸã€‚"
    print_info "æ³¨: Go ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¨ãƒªãƒã‚¸ãƒˆãƒªã¯ãã®ã¾ã¾æ®‹ã•ã‚Œã¦ã„ã¾ã™ã€‚"
    print_info "ã™ã¹ã¦ã‚’å®Œå…¨ã«å‰Šé™¤ã™ã‚‹ã«ã¯ã€ä»¥ä¸‹ã‚‚å‰Šé™¤ã§ãã¾ã™:"
    echo -e "${CYAN}1. ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å«ã‚€ãƒªãƒã‚¸ãƒˆãƒªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª${NC}"
    echo -e "${CYAN}2. $HOME/go/bin/ ã® Go ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼ˆ'gomvm install' ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸå ´åˆï¼‰${NC}"
    ;;
    
  "help"|"--help"|"-h")
    show_help
    ;;
    
  *)
    print_error "ä¸æ˜ãªã‚³ãƒãƒ³ãƒ‰: $1"
    show_help
    safe_exit 1
    ;;
esac

safe_exit 0
